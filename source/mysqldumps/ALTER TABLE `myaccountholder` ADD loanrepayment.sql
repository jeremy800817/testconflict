
ALTER TABLE `myaccountholder` ADD `ach_loanrepayment` decimal(20,6) NULL AFTER `ach_loanreference`;

/* View update */
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `vw_myaccountholder` AS select `account`.`ach_id` AS `ach_id`,`account`.`ach_partnerid` AS `ach_partnerid`,`account`.`ach_preferredlang` AS `ach_preferredlang`,`account`.`ach_fullname` AS `ach_fullname`,`account`.`ach_accountholdercode` AS `ach_accountholdercode`,`account`.`ach_email` AS `ach_email`,`account`.`ach_password` AS `ach_password`,`account`.`ach_oldpassword` AS `ach_oldpassword`,`account`.`ach_mykadno` AS `ach_mykadno`,`account`.`ach_phoneno` AS `ach_phoneno`,`account`.`ach_occupationcategoryid` AS `ach_occupationcategoryid`,`account`.`ach_occupationsubcategoryid` AS `ach_occupationsubcategoryid`,`account`.`ach_referralbranchcode` AS `ach_referralbranchcode`,`account`.`ach_referralsalespersoncode` AS `ach_referralsalespersoncode`,`account`.`ach_pincode` AS `ach_pincode`,`account`.`ach_sapacebuycode` AS `ach_sapacebuycode`,`account`.`ach_sapacesellcode` AS `ach_sapacesellcode`,`account`.`ach_bankid` AS `ach_bankid`,`account`.`ach_accountname` AS `ach_accountname`,`account`.`ach_accountnumber` AS `ach_accountnumber`,`account`.`ach_nokfullname` AS `ach_nokfullname`,`account`.`ach_nokmykadno` AS `ach_nokmykadno`,`account`.`ach_nokphoneno` AS `ach_nokphoneno`,`account`.`ach_nokemail` AS `ach_nokemail`,`account`.`ach_nokaddress` AS `ach_nokaddress`,`account`.`ach_nokrelationship` AS `ach_nokrelationship`,`account`.`ach_investmentmade` AS `ach_investmentmade`,`account`.`ach_ispep` AS `ach_ispep`,`account`.`ach_pepdeclaration` AS `ach_pepdeclaration`,`account`.`ach_kycstatus` AS `ach_kycstatus`,`account`.`ach_amlastatus` AS `ach_amlastatus`,`account`.`ach_pepstatus` AS `ach_pepstatus`,`account`.`ach_statusremarks` AS `ach_statusremarks`,`account`.`ach_emailverifiedon` AS `ach_emailverifiedon`,`account`.`ach_phoneverifiedon` AS `ach_phoneverifiedon`,`account`.`ach_status` AS `ach_status`,`account`.`ach_passwordmodified` AS `ach_passwordmodified`,`account`.`ach_lastnotifiedon` AS `ach_lastnotifiedon`,`account`.`ach_lastloginon` AS `ach_lastloginon`,`account`.`ach_lastloginip` AS `ach_lastloginip`,`account`.`ach_verifiedon` AS `ach_verifiedon`,`account`.`ach_createdon` AS `ach_createdon`,`account`.`ach_createdby` AS `ach_createdby`,`account`.`ach_modifiedon` AS `ach_modifiedon`,`account`.`ach_modifiedby` AS `ach_modifiedby`,`account`.`ach_partnercusid` AS `ach_partnercusid`,`account`.`ach_promocode` AS `ach_promocode`,`account`.`ach_type` AS `ach_type`,`account`.`ach_campaigncode` AS `ach_campaigncode`,`account`.`ach_loantotal` AS `ach_loantotal`,`account`.`ach_loanbalance` AS `ach_loanbalance`,`account`.`ach_loanapprovedate` AS `ach_loanapprovedate`,`account`.`ach_loanapproveby` AS `ach_loanapproveby`,`account`.`ach_loanstatus` AS `ach_loanstatus`,
`account`.`ach_loanreference` AS `ach_loanreference`,
`account`.`ach_loanrepayment` AS `ach_loanrepayment`,
`occupationcategory`.`occ_category` AS `ach_occupationcategory`,`occupationsubcategory`.`osc_code` AS `ach_occupationsubcategory`,`mygtp`.`partner`.`par_code` AS `ach_partnercode`,`mygtp`.`partner`.`par_name` AS `ach_partnername`,`mygtp`.`partner`.`par_parent` AS `ach_partnerparent`,`bank`.`bnk_code` AS `ach_bankcode`,`bank`.`bnk_name` AS `ach_bankname`,`address`.`add_line1` AS `ach_addressline1`,`address`.`add_line2` AS `ach_addressline2`,`address`.`add_city` AS `ach_addresscity`,`address`.`add_postcode` AS `ach_addresspostcode`,`address`.`add_state` AS `ach_addressstate`,`ledger`.`led_xaubalance` AS `ach_xaubalance`,`ledger`.`led_amountbalance` AS `ach_amountbalance` from ((((((`mygtp`.`myaccountholder` `account` left join `mygtp`.`partner` on((`mygtp`.`partner`.`par_id` = `account`.`ach_partnerid`))) left join `mygtp`.`mybank` `bank` on((`bank`.`bnk_id` = `account`.`ach_bankid`))) left join `mygtp`.`myaddress` `address` on((`address`.`add_accountholderid` = `account`.`ach_id`))) left join `mygtp`.`myoccupationcategory` `occupationcategory` on((`occupationcategory`.`occ_id` = `account`.`ach_occupationcategoryid`))) left join `mygtp`.`myoccupationsubcategory` `occupationsubcategory` on((`occupationsubcategory`.`osc_id` = `account`.`ach_occupationsubcategoryid`))) left join (select `ledger`.`led_accountholderid` AS `led_accountholderid`,sum((`ledger`.`led_credit` - (case when (`cvn`.`cvn_type` = 'CONVERSION_FEE') then 0 else `ledger`.`led_debit` end))) AS `led_xaubalance`,sum(((case when (`ledger`.`led_type` = 'BUY_FPX') then (`ord`.`ord_amount` + coalesce(`ord`.`ord_fee`,0)) else 0 end) - (case when (`cvn`.`cvn_type` = 'CONVERSION_FEE') then `cvn`.`cvn_amount` when (`ledger`.`led_type` = 'SELL') then (`ord`.`ord_amount` + coalesce(`ord`.`ord_fee`,0)) else 0 end))) AS `led_amountbalance` from (((`mygtp`.`myledger` `ledger` left join `mygtp`.`mygoldtransaction` `gtr` on((((`ledger`.`led_type` = 'BUY_FPX') or (`ledger`.`led_type` = 'SELL')) and (`gtr`.`gtr_id` = `ledger`.`led_typeid`)))) left join `mygtp`.`order` `ord` on((((`ledger`.`led_type` = 'BUY_FPX') or (`ledger`.`led_type` = 'SELL')) and (`gtr`.`gtr_orderid` = `ord`.`ord_id`)))) left join (select `cvn`.`cvn_id` AS `cvn_id`,`rdm`.`rdm_amount` AS `cvn_amount`,`rdm`.`rdm_type` AS `cvn_type` from (`mygtp`.`myconversion` `cvn` left join (select `mygtp`.`redemption`.`rdm_id` AS `rdm_id`,((`mygtp`.`redemption`.`rdm_redemptionfee` + `mygtp`.`redemption`.`rdm_insurancefee`) + `mygtp`.`redemption`.`rdm_handlingfee`) AS `rdm_amount`,'CONVERSION_FEE' AS `rdm_type` from `mygtp`.`redemption` union all select `mygtp`.`redemption`.`rdm_id` AS `rdm_id`,`mygtp`.`redemption`.`rdm_totalweight` AS `rdm_totalweight`,'CONVERSION' AS `CONVERSION` from `mygtp`.`redemption`) `rdm` on((`cvn`.`cvn_redemptionid` = `rdm`.`rdm_id`)))) `cvn` on(((`ledger`.`led_type` = 'CONVERSION') and (`cvn`.`cvn_id` = `ledger`.`led_typeid`)))) group by `ledger`.`led_accountholderid`) `ledger` on((`ledger`.`led_accountholderid` = `account`.`ach_id`)))

/* add loanapprovebyname view sql */

`loanapproveby`.`usr_name` AS `ach_loanapprovebyname`,
left join `user` AS loanapproveby on (loanapproveby.usr_id = `account`.`ach_loanapproveby`))